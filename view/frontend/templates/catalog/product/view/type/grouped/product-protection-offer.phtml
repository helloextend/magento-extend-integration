<?php
/*
 * Copyright Extend (c) 2023. All rights reserved.
 * See Extend-COPYING.txt for license details.
 */

/** @var $block Magento\GroupedProduct\Block\Product\View\Type\Grouped */
/** @var $escaper \Magento\Framework\Escaper */

$viewModel = $block->getData('viewModel');
$categoryModel = $block->getData('categoryModel');
$currencyCode = $viewModel->getCurrencyCode();
$isCurrencySupported = $viewModel->isCurrencySupported();
$shouldRender = $viewModel->isExtendProductProtectionEnabled() && $viewModel->isProductProtectionProductCatalogPageModalOfferEnabled() && $isCurrencySupported;
?>

<?php if ($shouldRender): ?>
  <table id="product_protection_offers">
    <?php foreach ($block->getAssociatedProducts() as $product): ?>
      <tr>
        <td class="product-protection-offer product-id-<?= $escaper->escapeHtml($product->getEntityId()); ?>" id="product_protection_offer_<?= $escaper->escapeHtml(preg_replace('/[^a-zA-Z0-9-_|]/', '', $product->getSku())); ?>" colspan="3" style="border-top: 0 !important"></td>
      </tr>
    <?php endforeach; ?>
  </table>
  <script type="text/x-magento-init">
    {
        "#product_protection_offers": {
            "productProtectionOffer": [
                <?php foreach ($block->getAssociatedProducts() as $key => $product): ?>
                    <?php
                      $categoryName = '';
                      $categories = $product->getCategoryIds();

                      if (count($categories) > 0) {
                        $categoryName = $categoryModel->getCategoryNameById($categories[0]);
                      }
                    ?>
                    {
                        "extendStoreUuid": "<?= $escaper->escapeJs($block->getData('viewModel')->getExtendStoreUuid()) ?>",
                        "activeEnvironment": "<?= $escaper->escapeJs($block->getData('viewModel')->getActiveEnvironment()) ?>",
                        "selectedProductSku": "<?= $escaper->escapeJs($product->getSku()); ?>",
                        "selectedProductId": "<?= $escaper->escapeJs($product->getId()); ?>",
                        "selectedProductPrice": "<?= $escaper->escapeJs($product->getPrice()); ?>",
                        "productCategory": "<?= $escaper->escapeJs($categoryName); ?>",
                        "currencyCode": "<?= $escaper->escapeJs($currencyCode) ?>"
                    }<?= array_key_last($block->getAssociatedProducts()) === $key ? '' : ',' ?>
                <?php endforeach; ?>
            ]
        }
    }
  </script>
  <script src="<?= $escaper->escapeUrl($block->getViewFileUrl('Extend_Integration::js/view/catalog/product/product-protection-grouped.js')) ?>"></script>
<?php endif; ?>

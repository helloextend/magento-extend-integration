<?php
/*
 * Copyright Extend (c) 2023. All rights reserved.
 * See Extend-COPYING.txt for license details.
 */

/** @var $block Magento\GroupedProduct\Block\Product\View\Type\Grouped */

$categoryName = '';

if ($category = $block->getProduct()->getCategory()) {
    $categoryName = $category->getName();
}

?>
<div id="product_protection_offers">
    <?php foreach ($block->getAssociatedProducts() as $product): ?>
        <div class="product-protection-offer" id="product_protection_offer_<?= $product->getSku(); ?>"></div>
    <?php endforeach; ?>
</div>
<script type="text/x-magento-init">
    {
        "#product_protection_offers": {
            "productProtectionOffer": [
            <?php foreach ($block->getAssociatedProducts() as $key => $product): ?>
                {
                    "extendStoreUuid": "<?= $block->getData('viewModel')->getExtendStoreUuid() ?>",
                    "activeEnvironment": "<?= $block->getData('viewModel')->getActiveEnvironment() ?>",
                    "selectedProductSku": "<?= $product->getSku(); ?>",
                    "selectedProductPrice": "<?= $product->getPrice(); ?>",
                    "productCategory": "<?= $categoryName; ?>"
                }<?= array_key_last($block->getAssociatedProducts()) === $key ? '' : ',' ?>
            <?php endforeach; ?>
            ]
        }
    }
</script>
